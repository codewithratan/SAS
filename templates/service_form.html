{% extends "base.html" %}

{% block title %}{{ title }} - Harkrishan Gallery and Services{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-fill customer details if customer_id is provided
        const customerIdInput = document.getElementById('customer_id');
        const customerDetails = document.getElementById('customer-details');
        
        if (customerIdInput && customerDetails) {
            function fetchCustomerDetails() {
                const customerId = customerIdInput.value;
                if (customerId) {
                    fetch(`/api/customer/${customerId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                customerDetails.innerHTML = `
                                    <div class="alert alert-warning">
                                        ${data.error}
                                    </div>
                                `;
                            } else {
                                customerDetails.innerHTML = `
                                    <h6>Customer Details</h6>
                                    <p class="mb-1"><strong>Name:</strong> ${data.name}</p>
                                    <p class="mb-1"><strong>Contact:</strong> ${data.contact_number}</p>
                                    <p class="mb-1"><strong>Email:</strong> ${data.email || 'N/A'}</p>
                                    <p class="mb-0"><strong>Address:</strong> ${data.address || 'N/A'}</p>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            customerDetails.innerHTML = `
                                <div class="alert alert-danger">
                                    Error fetching customer details. Please check the customer ID.
                                </div>
                            `;
                        });
                } else {
                    customerDetails.innerHTML = '';
                }
            }
            
            // Initial fetch if customer_id is pre-filled
            if (customerIdInput.value) {
                fetchCustomerDetails();
            }
            
            // Add event listener for changes
            customerIdInput.addEventListener('change', fetchCustomerDetails);
        }
        
        // Auto-format IMEI input
        const imeiInput = document.getElementById('imei_number');
        if (imeiInput) {
            imeiInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                let value = e.target.value.replace(/\D/g, '');
                
                // Format as 15 or 16 digits with hyphens
                if (value.length > 4) {
                    value = value.replace(/^(\d{4})/, '$1-');
                }
                if (value.length > 9) {
                    value = value.replace(/^(\d{4})-(\d{4})/, '$1-$2-');
                }
                if (value.length > 14) {
                    value = value.replace(/^(\d{4})-(\d{4})-(\d{4})/, '$1-$2-$3-');
                }
                
                // Update the input value
                e.target.value = value;
            });
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">{{ title }}</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="">
                    {{ form.hidden_tag() }}
                    
                    <h5 class="mb-3">Customer Information</h5>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.customer_id.label(class="form-label required") }}
                                {{ form.customer_id(class="form-control" + (' is-invalid' if form.customer_id.errors else '')) }}
                                {% if form.customer_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.customer_id.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Enter customer ID or search for a customer</small>
                            </div>
                            
                            <div id="customer-details" class="mt-3 p-3 bg-light rounded">
                                {% if customer %}
                                    <h6>Customer Details</h6>
                                    <p class="mb-1"><strong>Name:</strong> {{ customer.name }}</p>
                                    <p class="mb-1"><strong>Contact:</strong> {{ customer.contact_number }}</p>
                                    <p class="mb-1"><strong>Email:</strong> {{ customer.email or 'N/A' }}</p>
                                    <p class="mb-0"><strong>Address:</strong> {{ customer.address or 'N/A' }}</p>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex flex-column h-100">
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle"></i> Need to add a new customer?</h6>
                                    <p class="mb-0">If the customer is not in the system, please add them first using the button below.</p>
                                </div>
                                <div class="mt-auto">
                                    <a href="{{ url_for('new_customer') }}" class="btn btn-outline-primary w-100">
                                        <i class="bi bi-person-plus"></i> Add New Customer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">Device Information</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.brand.label(class="form-label required") }}
                                {{ form.brand(class="form-control" + (' is-invalid' if form.brand.errors else '')) }}
                                {% if form.brand.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.brand.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.model_name.label(class="form-label required") }}
                                {{ form.model_name(class="form-control" + (' is-invalid' if form.model_name.errors else '')) }}
                                {% if form.model_name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.model_name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.imei_number.label(class="form-label") }}
                                {{ form.imei_number(class="form-control" + (' is-invalid' if form.imei_number.errors else '')) }}
                                {% if form.imei_number.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.imei_number.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Format: XXXX-XXXX-XXXX-XXXX</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.warranty_status.label(class="form-label required") }}
                                {{ form.warranty_status(class="form-select" + (' is-invalid' if form.warranty_status.errors else '')) }}
                                {% if form.warranty_status.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.warranty_status.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">Service Details</h5>
                    <div class="mb-3">
                        <div class="form-group">
                            {{ form.problem_description.label(class="form-label required") }}
                            {{ form.problem_description(class="form-control" + (' is-invalid' if form.problem_description.errors else ''), rows=3) }}
                            {% if form.problem_description.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.problem_description.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.device_condition.label(class="form-label") }}
                                {{ form.device_condition(class="form-control" + (' is-invalid' if form.device_condition.errors else ''), rows=2) }}
                                {% if form.device_condition.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.device_condition.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ form.estimate.label(class="form-label") }}
                                <div class="input-group">
                                    <span class="input-group-text">â‚¹</span>
                                    {{ form.estimate(class="form-control" + (' is-invalid' if form.estimate.errors else '')) }}
                                </div>
                                {% if form.estimate.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.estimate.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-group">
                            {{ form.remarks.label(class="form-label") }}
                            {{ form.remarks(class="form-control" + (' is-invalid' if form.remarks.errors else ''), rows=2) }}
                            {% if form.remarks.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.remarks.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="form-group">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (' is-invalid' if form.notes.errors else ''), rows=3) }}
                            <small class="form-text text-muted">Internal notes (not shown to customer)</small>
                            {% if form.notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> {{ form.submit.label.text }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
